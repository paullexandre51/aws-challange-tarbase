Resources:
  
  S3Bucket:
    Type: 'AWS::S3::Bucket'
    DeletionPolicy: Delete
    Properties:
      BucketName: tarbase-055982054152-paulo
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: KMS-KEY-ARN
      Tags: 
        - Key: "Name"
          Value: "S3-CF"   
  
  MyStorage:
     Type: 'AWS::EC2::Volume'
     Properties:
       AvailabilityZone: eu-west-1a
       Encrypted: True
       Size: 10
       Tags: 
        - Key: "Name"
          Value: "Storage-CF"   

  SG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH to Access Instance
      VpcId: vpc-4c61f92a
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
      - IpProtocol: -1
        FromPort: -1
        ToPort: -1
        CidrIp: 0.0.0.0/0  
      Tags: 
        - Key: "Name"
          Value: "SecurityGroup-CF"     
  
  MyEC2Instance: 
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: eu-west-1a
      ImageId: "ami-0fc970315c2d38f01"
      KeyName: "aws-cha"
      InstanceType: t3a.micro
      UserData: 
       !Base64 |
       #!/bin/bash
       tar -czf tar.tgz /var/log
       mv tar.tgz /home/ec2-user
       mkdir /mnt/external-storage
       mkfs -t ext4 /dev/nvme1n1
       echo "/dev/nvme1n1  /mnt/external-storage ext4  defaults,nofail 0 2" >> /etc/fstab
       mount -a
       yum  update -y
      Tags: 
        - Key: "Name"
          Value: "Linux-Instance-CF"
      SecurityGroupIds:
        - !Ref SG
  
  AttachStorage:
    Type: AWS::EC2::VolumeAttachment
    Properties: 
      Device: /dev/sdh
      InstanceId: !Ref MyEC2Instance
      VolumeId: !Ref MyStorage

 

 
